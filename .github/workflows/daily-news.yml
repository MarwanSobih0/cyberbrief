name: Daily Cyber News Collector

on:
  schedule:
    # 8:00 ØµØ¨Ø§Ø­Ø§Ù‹ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ù…ØµØ± â‰ˆ 5:00 UTC
    - cron: '0 5 * * *'
  workflow_dispatch:

permissions:
  contents: write  # ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ§Ù„Ù€ push

concurrency:
  group: daily-cyberbrief-collector
  cancel-in-progress: false

jobs:
  collect-news:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # history ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ù€ commit ÙˆØ§Ù„Ù€ push ÙŠØ¨Ù‚ÙˆØ§ Ø«Ø§Ø¨ØªÙŠÙ†

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # ØªÙØ¹ÙŠÙ„ cache Ù„Ù„Ù€ pip Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ù€ workflow ÙŠØ¨Ù‚Ù‰ Ø£Ø³Ø±Ø¹

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            echo "Using requirements.txt..."
            pip install -r requirements.txt
          else
            echo "requirements.txt not found â€” installing minimal deps..."
            pip install feedparser requests
          fi

      - name: Run news collector
        env:
          # Ù„Ùˆ daily_news_collector.py Ø¨ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ CYBERBRIEF_DIR
          CYBERBRIEF_DIR: ${{ github.workspace }}
        run: |
          python daily_news_collector.py

      - name: Commit and push if there are changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Cyberbrief Bot"

          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù„ÙŠ Ø¨ØªØªÙˆÙ„Ø¯ ÙŠÙˆÙ…ÙŠØ§Ù‹
          git add cybersecurity_news_*.json CYBERBRIEF_*.txt || echo "No files to add"

          # Ù„Ùˆ Ù…ÙÙŠØ´ Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§ØªØŒ Ù…Ø§ Ù†Ø¹Ù…Ù„Ø´ commit ÙØ§Ø¶ÙŠ
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "ğŸ¤– Daily update: Cybersecurity news [$(date -u +'%Y-%m-%d %H:%M UTC')]"

          # Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù€ remote Ø´ØºØ§Ù„ Ø¨Ø§Ù„ØªÙˆÙƒÙ†
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Push Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù€ branch Ø§Ù„Ù„ÙŠ Ø´ØºØ§Ù„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„workflow (ØºØ§Ù„Ø¨Ø§Ù‹ main)
          git push origin HEAD
